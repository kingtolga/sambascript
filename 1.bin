#!/usr/bin/env bash
#
#   9 AUGUST 2020
#   TOLGA EROK
#   kingtolga@gmail.com


#======================= System Setup =======================#

#   INSTALL CUSTOM APPS
#   for a in {1..15}; do sleep .08s; echo $a| dialog --gauge "waiting" 7 30; done
    read -r -p "Installing custom packages" -t 2 -n 1 -s
    sudo apt-get update
    sudo add-apt-repository ppa:transmissionbt/ppa
    sudo apt-get update
    sudo apt-get -y install libaio1 libaio-dev libxss1 libappindicator1 libindicator7 gedit samba smbclient transmission-qt autokey-gtk clipit sublime-text ffmpeg  idle mpv vlc fatsort geany smplayer openssh-server git  transmission-qt dconf-editor soundconverter calibre
    sudo curl -L https://yt-dl.org/downloads/latest/youtube-dl -o /usr/local/bin/youtube-dl
    sudo chmod a+rx /usr/local/bin/youtube-dl
    read -r -p "Finished ..." -t 2 -n 1 -s
    clear
#   for a in {1..15}; do sleep .08s; echo $a| dialog --gauge "waiting" 7 30; done

#======================= System Tweaks =======================#

#   FIX USB NEVER FINISHES
    read -r -p "Apply USB never finishes fix" -t 2 -n 1 -s
    echo vm.dirty_bytes=15000000 | sudo tee -a /etc/sysctl.conf
    read -r -p "Finished ..." -t 1 -n 1 -s
    echo "Continuing ...."
    clear

#   REDUCE TIMEOUTS ON SHUTDOWN/REBOOT FIX
    read -r -p "Apply Shutdown time outs Fix" -t 2 -n 1 -s
    sudo sed -i 's/#DefaultTimeoutStartSec=90s/DefaultTimeoutStartSec=4s/g'  /etc/systemd/system.conf
    sudo sed -i 's/#DefaultTimeoutStopSec=90s/DefaultTimeoutStopSec=4s/g'    /etc/systemd/system.conf
    read -r -p "Finished ...." -t 1 -n 1 -s
    echo "Continuing ...."
    clear


#======================= Samba Setup =======================#

#   INSTALL SAMBA SERVICES
    read -r -p "Insalling custom SAMBA packages" -t 2 -n 1 -s
    sudo apt-get install samba --install-recommends acl cifs-utils nemo-share ibaio1 python-dnspython samba-dsdb-modules samba-vfs-modules
    sudo apt install tasksel
    sudo tasksel install samba-server
    read -r -p "Finished ..." -t 1 -n 1 -s

#   STOP START SERVICE
    sudo systemctl restart smbd

#   BACKUP & CREATE NEW SMB.FILE
    read -r -p "Backing up smb file" -t 2 -n 1 -s
    sudo cp /etc/samba/smb.conf /etc/samba/smb.conf_backup
    read -r -p "Wait 2 seconds or press any key to continue immediately" -t 2 -n 1 -s
    echo "Continuing ...."
    clear

#   CLEANUP BY REMOVING # & ; INSIDE SMB.FILE
    read -r -p "Cleaning up smb file" -t 2 -n 1 -s
    sudo bash -c 'grep -v -E "^#|^;" /etc/samba/smb.conf_backup | grep . > /etc/samba/smb.conf'
    read -r -p "Wait 2 seconds or press any key to continue immediately" -t 2 -n 1 -s
    echo "Continuing ...."
    clear

#   CHECK FOR SMB.CONF ERRORS
    testparm -s


#======================= Share Definitions =======================#

#   ADD SMB GROUP
    sudo groupadd samba

#   ADD SMB USER & GROUP  acl
    read -r -p "Configuring SAMBA username" -t 2 -n 1 -s
    sudo smbpasswd -a tolga
    sudo gpasswd -a tolga samba
    read -r -p "Completed ... " -t 1 -n 1 -s
    echo "Continuing ...."
    clear

#   ADD PRIVATE SHARE
    read -r -p "Configuring [PRIVATE] in smb file" -t 2 -n 1 -s
    sudo cat ../CONFIG/private.txt | sudo tee -a /etc/samba/smb.conf
    sudo mkdir -p /srv/samba/private/
    sudo setfacl -R -m "g:samba:rwx" /srv/samba/private/
    read -r -p "Finished ..." -t 1 -n 1 -s
    echo "Continuing ...."
    clear

#   TEST FOR ERRORS & RESTART SERVICES
    testparm -s
    sudo systemctl restart smbd nmbd
    read -r -p "Restarting SMB & NMBD service" -t 2 -n 1 -s
    echo "Done ...."
    clear

#   ADD PUBLIC SHARE
    read -r -p "Configuring [PUBLIC] in smb file" -t 2 -n 1 -s
    sudo cat ../CONFIG/public.txt | sudo tee -a /etc/samba/smb.conf
    sudo mkdir -p /srv/samba/public
    sudo setfacl -R -m "u:nobody:rwx" /srv/samba/public/
    sudo systemctl restart smbd nmbd
    read -r -p "Completed ..." -t 1 -n 1 -s
    echo "Continuing ...."
    clear

#   ADD SMB1 EQUILIVANT NETWORK PROTOCOLS INTO SMB.CONF
    read -r -p "Configuring [GLOBAL] in smb file" -t 2 -n 1 -s
    sudo sed -i '/^\[global\]/r ../CONFIG/global.txt' /etc/samba/smb.conf
    read -r -p "Done" -t 1 -n 1 -s
    clear

#   ADD USER HOME TO BOTTOM OF SMB.CONF
    read -r -p "Configuring [HOME] in smb file" -t 2 -n 1 -s
    sudo cat ../CONFIG/home.txt | sudo tee -a /etc/samba/smb.conf
    read -r -p "Completed" -t 1 -n 1 -s
    echo "Continuing ...."
    clear

#   START FIREWALL WITH SAMBA PROTOCOLS
    sudo ufw allow samba

#   CREATE MOUNT POINT FOR SAMBA PRIVATE SHARE
    sudo mkdir /mnt/samba-private

#   MOUNT POINT FOR SAMBA PRIVATE SHARE
    gedit ../NOTES/mount_notes.txt
    read -r -p "Mounting samba-private folder" -t 2 -n 1 -s
    sudo mount -t cifs -o username=tolga //192.168.0.20/private /mnt/samba-private/
    read -r -p "Completed ... " -t 1 -n 1 -s
    echo "Continuing ...."

#   CREATE CREDENTIAL FILE
    read -r -p "Wait 10 seconds COPY FROM NOTES INTO CREDENTIALS" -t 10 -n 1 -s
    echo "Opening samba_credtial notes ...."
    gedit ../NOTES/samba_credtial.txt
    sudo gedit /etc/samba-credential.conf

#   ONLY ROOT USERS CAN ACCESS
    sudo chmod 600 /etc/samba-credential.conf

#   CHECK FOR SMB.CONF ERRORS
    testparm -s

#   RESTART SAMBA SERVICES
    read -r -p "Restarting SMB services" -t 1 -n 1 -s
    sudo systemctl start smbd.service
    sudo systemctl enable smbd.service

#   WRITE TEST FILES
    touch /var/samba/public-share
    touch /home/tolga/home-share
    read -r -p "Done ..." -t 1 -n 1 -s
    echo "Continuing ...."
    clear

#   LIST SAMBA-SHARES AND CURRENT USERS
    sudo smbstatus
    sudo smbclient -L host
    sudo smbstatus --shares
    sudo pdbedit -L -v
    sudo net usershare info --long
    read -r -p "Press any key to exit ... (25secs)" -t 25 -n 1 -s

#   LIST NETWORk PC IP's & MAC ADDRESSES
    read -r -p "List IP's & MAC addresses" -t 2 -n 1 -s
    sudo arp -a
    read -p "Press any key to exit ... (25secs)" -t 25 -n 1 -s
    echo "Continuing ...."
    clear

#=======================	Setup WS-Discovery	=======================#
#	REF:	https://forums.linuxmint.com/viewtopic.php?f=42&t=199907

#	DOWNLOAD FILE
    read -r -p "Download WS-DISCOVERY" -t 2 -n 1 -s
	wget https://github.com/christgau/wsdd/archive/master.zip

#	UNZIP
	unzip master.zip

#	RENAME PY SCRIPT
	sudo mv wsdd-master/src/wsdd.py wsdd-master/src/wsdd

#	COPY TO BIN FOLDER
	sudo cp wsdd-master/src/wsdd /usr/bin

#	COPY THE SYSTEMD SERVICE FILE TO /ETC/SYSTEMD/SYSTEM
	sudo cp wsdd-master/etc/systemd/wsdd.service /etc/systemd/system
    read -r -p "Completed, extracted and copied" -t 2 -n 1 -s

#	EDIT THE WSDD.SERVICE FILE TO REMOVE REFERENCES TO THE NOBODY USER AND ADD A SLEEP COMMAND - CHANGES IN RED
	sudo gedit ../NOTES/wsdd.txt
	sudo nano /etc/systemd/system/wsdd.service

#
#	 		[Service]
#			Type=simple
#	 >>>>   ExecStartPre=/bin/sleep 2
#			ExecStart=/usr/bin/wsdd --shortlog
#			; Replace those with an unprivledged user/group that matches your environment,
#			; like nobody/nogroup or daemon:daemon or a dedicated user for wsdd
#	 >>>>   #User=nobody
#	 >>>>   #Group=nobody

#	RELOAD THE SERVICE
	sudo systemctl daemon-reload

#	START THE SERVICE
	sudo systemctl start wsdd

#	ENABLE THE SERVICE SO IT STARTS AT BOOT
	sudo systemctl enable wsdd
    read -r -p "Restarting WS-DISCOVERY services ... " -t 2 -n 1 -s
    read -r -p "Done" -t 1 -n 1 -s
    clear

#======================= Office Suites =======================#

#   INSTALL WPS
    read -r -p "Download & install WPS office suite" -t 2 -n 1 -s
    wget http://wdl1.pcfg.cache.wpscdn.com/wpsdl/wpsoffice/download/linux/9615/wps-office_11.1.0.9615.XA_amd64.deb
    sudo apt install -y  ./wps-office*.deb
    sudo apt-get install -f
    read -r -p "Completed ..." -t 1 -n 1 -s
    clear

#======================= Browser Suites =======================#

#   INSTALL Chrome
    read -r -p "Download & install Chrome Browser" -t 2 -n 1 -s
    wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
    sudo apt install -y  ./google-chrome*.deb
    sudo apt-get install -f
    read -r -p "Completed ..." -t 1 -n 1 -s
    clear
    clear

    read -r -p "Display distro release info" -t 2 -n 1 -s
    sudo lsb_release -a
    read -r -p "Wait 5 seconds or press any key to continue immediately" -t 5 -n 1 -s
    read -r -p "REBOOT SYSTEM ..." -t 10 -n 1 -s



#======================= Misc =======================#
# echo 'UUID=1e5a2560-a80f-4638-aba0-d754b67de77d   /media/titojff/932G   ext4      defaults     0      0
# /dev/disk/by-uuid/993746df-fc86-4671-a061-004b66b1bd21 /media/titojff/wi7 auto nosuid,nodev,nofail,x-gvfs-show 0 0' | sudo tee -a /etc/fstab
